generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Match {
  id            String         @id @default(uuid())
  uploadUrl     String
  status        MatchStatus    @default(UPLOADED)
  progress      Int            @default(0) // Processing progress 0-100
  duration      Float?         // in seconds (float for precision)
  summary       String?        // AI-generated match narrative
  highlightReelUrl String?     // URL to the combined highlight reel
  trackingData  Json?          // ball + person bounding boxes per sampled frame
  teamColors    Json?          // [[R,G,B],[R,G,B]] detected jersey colours
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  events        Event[]
  emotionScores EmotionScore[]
  highlights    Highlight[]
}

model Event {
  id          String    @id @default(uuid())
  matchId     String
  match       Match     @relation(fields: [matchId], references: [id], onDelete: Cascade)
  timestamp   Float     // seconds, precision to 0.01s
  type        EventType
  confidence  Float     // 0.0-1.0
  finalScore  Float     @default(0) // 0-10 scale, see compute_context_score()
  commentary  String?
  createdAt   DateTime  @default(now())
  
  @@index([matchId])
  @@index([timestamp])
}

model EmotionScore {
  id            String   @id @default(uuid())
  matchId       String
  match         Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  timestamp     Float    // seconds
  audioScore    Float    // 0.0-1.0
  motionScore   Float    // 0.0-1.0
  contextWeight Float    // 0.0-1.0 time-based weight
  finalScore    Float    // 0-10 composite score
  createdAt     DateTime @default(now())
  
  @@index([matchId])
  @@index([timestamp])
}

model Highlight {
  id          String   @id @default(uuid())
  matchId     String
  match       Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  startTime   Float    // seconds, inclusive
  endTime     Float    // seconds, exclusive
  score       Float    // 0-10 highlight significance
  eventType   String?  // e.g., "GOAL", "SAVE", "TACKLE"
  commentary  String?  // highlight description
  videoUrl    String?  // optional URL to highlight clip
  createdAt   DateTime @default(now())
  
  @@index([matchId])
  @@index([startTime])
}

enum MatchStatus {
  UPLOADED
  PROCESSING
  COMPLETED
  FAILED
}

enum EventType {
  GOAL
  FOUL
  TACKLE
  SAVE
  CELEBRATION    // SoccerNet/Vision AI detected celebration
  HIGHLIGHT      // Generic fallback highlight from motion analysis
  PENALTY
  RED_CARD
  YELLOW_CARD
  CORNER
  OFFSIDE
}
